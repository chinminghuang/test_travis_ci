dist: xenial
language: python
python:
- '3.7'

notifications:
  email:
    recipients: chinming@writepath.co
    on_success: always
    on_failure: always

stages:
- unittest
- docker_build
- deploy
- functional_test

install:
- pip install -r requirements.txt

jobs:
  include:
  - stage: unittest
    name: Unit Tests
    script: pytest

  - stage: docker_build
    name: Build docker
    if: branch =~ /^(master|dev)$/ && type IN (pull_request)
    sudo: required
    services: docker
    before_install:
    - ./ecr_credentials.sh
    install: pip3 install awscli --upgrade
    script:
    - echo $ENC_AWS_ACCESS_KEY_ID
    - source cmd.sh && test_bash
    - docker build -t docsvc .
    after_success:
    - eval $(aws ecr get-login --region us-east-1)
    - docker tag docsvc:latest $AWS_ECR_DOCSVC_DEV_REPO:latest
    - docker push $AWS_ECR_DOCSVC_DEV_REPO:latest

  - stage: deploy
    name: Deploy for dev
    if: branch = dev && type IN (pull_request)
    sudo: required
    script: echo "Deploy for dev"
  - name: Deploy for master
    if: branch = master && type IN (pull_request)
    sudo: required
    script: echo "Deploy for master"

  - stage: functional_test
    if: branch = dev && type IN (pull_request)
    script: echo "Functional test"

env:
  global:
  - secure: $ENC_AWS_ACCESS_KEY_ID
  - secure: $ENC_AWS_SECRET_ACCESS_KEY
